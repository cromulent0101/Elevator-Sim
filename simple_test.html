<!-- most of this code was written by GPT-3 -->
<!DOCTYPE html>
<html>
<head>
<title>Paste Data</title>
</head>
<body>
  <form id="myForm">

    <!-- <label for="name">step_delays:</label>
    <input type="text" id="step_delays" name="step_delays"><br>
    <label for="stop_delays">stop_delays:</label>
    <input type="text" id="stop_delays" name="stop_delays"><br>
    <label for="floors_traversed">floors_traversed:</label>
    <input type="text" id="floors_traversed" name="floors_traversed"><br>
    <label for="log_dict">log_dict:</label>
    <input type="text" id="log_dict" name="log_dict"><br> -->

    <!-- <label for="rider_list">rider_list:</label>
    <textarea type="text" id="rider_list" name="rider_list">enter rider things here

    </textarea><br> -->
    <label for="num_elevators">num_elevators:</label>
    <input type="text" id="num_elevators" name="num_elevators"><br>
    <label for="TIME_STEP">TIME_STEP:</label>
    <input type="text" id="TIME_STEP" name="TIME_STEP"><br>
    <label for="elevate_type">elevate_type:</label>
    <input type="text" id="elevate_type" name="elevate_type"><br>

    <input type="submit" value="Submit">

  </form>
  <div id="response"></div>
  <div id="my-image"></div>

  <input type="file" id="csvfile" accept=".csv">
  <button type="button" id="validateBtn">Validate CSV</button>

<script>
  // Define a function to check for the image file. THere's gotta be a better way
  function checkForImage(graph_id) {
    // Try to load the image using its file path
    const fileUrl = `graphs/${graph_id}.png`; // Change this to the path of your image file
    const http = new XMLHttpRequest();
    http.open("HEAD", fileUrl, false);
    http.send();
    // console.log(http.status)
    // If the status code is 200, the file exists
    if (http.status === 200) {
      // Create a new image element with the found file path
      const foundImg = document.createElement("img");
      foundImg.src = fileUrl;
      
      // Replace the existing image element in the DOM with the found image element
      img.parentNode.replaceChild(foundImg, img);
      imageFound = true;
    }
  }

  document.getElementById('myForm').addEventListener('submit', function(event) {
          // Prevent default form submission behavior
    event.preventDefault();
  
    const data = new FormData(event.target);
    data.append("rider_list",contents);
  
    console.log(data);
    fetch('http://localhost:8000/api/simulation-requests/', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Object.fromEntries(data))
    })
    .then((response) => response.text())
    // .then(json => console.log(json))
    .then((text) => {
      // Display response to user
      jason = JSON.parse(text)
      document.getElementById('response').innerHTML = text;
    });
    

    ////////////////////
    // Graph Stuff
    ////////////////////

    // need to load graph PNG here at some points
    const img = document.getElementById("my-image");

    // Set a flag to track whether the image has been found
    let imageFound = false;

    // Check for the image file every 500 milliseconds (0.5 seconds)
    const intervalId = setInterval(() => {
      if (!imageFound) {
        console.log(jason.graph_id)
        checkForImage(jason.graph_id);
      } else {
        clearInterval(intervalId);
      }
    }, 500);

    // Give up after 10 seconds
    setTimeout(() => {
      clearInterval(intervalId);
    }, 10000);
  });

  // Get the image element from the DOM
  const img = document.getElementById("my-image");

  // Set a flag to track whether the image has been found
  let imageFound = false;


  // Check for the image file every 500 milliseconds (0.5 seconds)
  // TODO: find a better way to do this without constant polling
  const intervalId = setInterval(() => {
    if (!imageFound) {
      checkForImage();
    } else {
      clearInterval(intervalId);
    }
  }, 500);

  // Give up after 10 seconds
  setTimeout(() => {
    clearInterval(intervalId);
  }, 10000);

  let file;

  document.getElementById('csvfile').addEventListener('change', function (event) {
      file = event.target.files[0];
      if (file) {
          document.getElementById('validateBtn').disabled = false;
      }
  });





  document.getElementById('validateBtn').addEventListener('click', function () {
    if (!file) {
        alert('Please select a CSV file first.');
        return;
    }
    
    // const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
          // console.log('i loaded file');
          var contents = e.target.result; // should I use var here?
          console.log(contents)
          // console.log(data)
          const lines = contents.split('\n');
          const regexRules = [
              /^[a-zA-z0-9]+$/,
              /^\d+$/,
              /^\d+$/,
              /^\d+\r?/
          ];

          let isValid = true;

          for (const line of lines) {
              // console.log(line);
              const cells = line.split(',');
              // console.log(cells);
              for (let i = 0; i < cells.length; i++) {
                  if (!regexRules[i].test(cells[i])) {
                      // console.log(cells[i])
                      isValid = false;
                  }
              }
          }

          if (isValid) {
              alert('The CSV is valid.');
          } else {
              alert('The CSV is not valid.');
          }
      };

      reader.onerror = function () {
          alert('Error reading the CSV file.');
      };

      reader.readAsText(file);
  });
  </script>
</body>
</html>